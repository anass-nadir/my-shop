name: Common Package CD

on:
  push:
    paths: 
      - "server/common/**"
jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: "server/common"
    steps:
    - uses: actions/checkout@v2
    - 
      name: Run Specs
      uses: actions/setup-node@v2.1.4
      with:
        node-version: "14"
    - run: npm ci
    - run: npm test
  publish:
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: "server/common"
    steps:
    - uses: actions/checkout@v2
    - name: Check version changes
      uses: EndBug/version-check@v1
      id: check
      with:
        assume-same-version: new
        static-checking: localIsNew
        file-url: https://unpkg.com/@my-shop/common/package.json
        file-name: ./server/common/package.json
    - 
      if: steps.check.outputs.changed == 'true'
      name: Publish the common package 
      uses: actions/setup-node@v2.1.4
      with:
        node-version: "14"
        registry-url: 'https://registry.npmjs.org'
        scope: '@my-shop'
    - run: npm install --silent
    - run: npm run build
    - run: npm publish --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
  